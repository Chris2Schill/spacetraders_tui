-- local token =
-- "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGlmaWVyIjoiRkFUSE9SU0VOSVBTIiwidmVyc2lvbiI6InYyLjIuMCIsInJlc2V0X2RhdGUiOiIyMDI0LTAzLTI0IiwiaWF0IjoxNzExMzgyNTMwLCJzdWIiOiJhZ2VudC10b2tlbiJ9.OlvQa9W9GXppxpJZLSNsHbHR2V9kD5jlRnmFdq9qMaIow-ZHH3734q7a9oM11IUTIHVOpWmk1-dpuPGC1QKg7X6Ib_E160IiqHV08e6s9JHt07G-vySMsbA6iaI5cJp4zAGHp2ydgpBe6JwH5gU4bcGl6xmstLV3LVdsIIht73gRFt3oZKl-TsZYAnHvr8n-HHw7RMTZL1NM0alxUZldscc3wgIcfpr87dxYGNbFPCGlVx58IzNNMjhOwjw4ffcV3yy34W8iQTyhd5x9vMaNrHe_JuQPPtGhN1xy0qB4QFokuZPcV_2zK72X8DqtOds6ASMMtwCwPVWEl9URIda4xg"
-- local token = "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGlmaWVyIjoiRkFUSE9SU0VOSVBTMiIsInZlcnNpb24iOiJ2Mi4yLjAiLCJyZXNldF9kYXRlIjoiMjAyNC0wMy0yNCIsImlhdCI6MTcxMTgxNTI2OSwic3ViIjoiYWdlbnQtdG9rZW4ifQ.lpCj-bFzlC6vppRqeiX28UsKmDuFTmcwep_2pHgJYvn3TPX5NZ_YVDeY6_2YcE6z0ClEmpob2BPxr-avuBims-KFZUpZfGToHhvT5u2uPlkTLhMQGCi1m3wjIDBOVAW0sTM1ToddsECb2nG_YG7K9tBo6jAThx-q412Zx3lUAq6f3CPEplxPeBXbT68lq58Nx2Xqv3lhnZhbYDiFClSGCXdICYswWkWd58k7XTFUlYzdhsR0DE0AfKCMqqpBxzdnLgv2n0-EkOIHdpp77OygX7Qq4o5eVMJguJdIYwaysjgMlrLal9r3sdxQSJtvjmF508GJ9kei4nJn9sOQ12uN6w"
-- local token="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGlmaWVyIjoiRkFUSE9SU0VCSVRTIiwidmVyc2lvbiI6InYyLjIuMCIsInJlc2V0X2RhdGUiOiIyMDI0LTAzLTI0IiwiaWF0IjoxNzEyMzM5MDk3LCJzdWIiOiJhZ2VudC10b2tlbiJ9.ybiy5jAaFCkQfG5NmN3_0cxpqnZbdSWiXDAGqJVL2ICuu8XDL7W0upJV7nmklayX9Yrc3U-4pDG7utLLYDWs2DX-YDqYTf6EqNdFHYryqOUQVU6qGkusXlRsb2BQMS_0e5bfbOHqEzDgHLZr8YtELJY_glzZFH3l2D2Io3PoFn3IeupD3ulr2HngM7RO_kHK0t5GZ7yM-7bK23duZv2OYfLukYT2_UcqfTNevaGdgay5BGkQf36BpGgyBYUCGcyE0NUcXCXTEqHgTiOew6B96Bbw2zkXTbkQ871XEDTdRacpyh2jRsSIq1czCcTf1sS7rKysHg4lsjzz0MEpp47dkQ"
-- local token="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGlmaWVyIjoiRkFUSE9SU0VOSVBTIiwidmVyc2lvbiI6InYyLjIuMCIsInJlc2V0X2RhdGUiOiIyMDI0LTA0LTA5IiwiaWF0IjoxNzEzNTQ1MDcyLCJzdWIiOiJhZ2VudC10b2tlbiJ9.RpK3mNe14CNo4U03RHLZWjcEYRstqbb15KrE36f_7SxDtPMWJ2tVvUztudqGACZH9N0UFY2PLhsDVnl0oaFSoIAsiGZ7IMqRtjUPRplONdOg5nVKK0yVrRGSmOMktviSq6R8gcPQ-kZmMMfvE8k3zhb0ZhdVb08UvguIllsSQUbrQymH1h8ow52Mqu124P_cY_sMbUEMV2G-y-44wjr5Zxvh1dU1UCb6ptX2KBuhTgx_XF8Wb2OjN9QmfdT6MqGllR4b9zhvmKwCdWWQyaSd4sHVLHGSlSRc_xOl8QJr7wv89HW0BoyXolJNy6obb8Qy2QtH0HwZou7aakufr2hFDQ"

local token="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZGVudGlmaWVyIjoiU0NISUxMTUFOIiwidmVyc2lvbiI6InYyLjIuMCIsInJlc2V0X2RhdGUiOiIyMDI0LTA2LTMwIiwiaWF0IjoxNzE5OTU3NzE0LCJzdWIiOiJhZ2VudC10b2tlbiJ9.eAtidSL5fXihTUzEQ9drTa6YAmAGb0djn1bJBVK-MrsbzRpQh3gpPIvDOeA_EE51TFr62wvg2tep65zG774k-cz3qedyf4ByI-NKZAo4VIOKe6iSygiq7pClT-xzCtK9QT95-4c3ELWejJ8jPS7oq0gbPZFeGArRmW29Ai6Lw5kqDOtJm-mqkpS3BwXuh4hXNh38fn8R2GUXpISfZmYlQQto9r7rRX2jaTB1r1Bdq9Pb8C27KDowKEI8Bnuv6HDGJhQAVsPI2VFUHD1_J7CjwWxqB47N9ri-H3n2buiAuV1e_70IARtu_uGmILGWE-AHJhUInIzajtEJNGtOuO5sjg"
require('openapiclient.api.apikey').api_key = token



local authority = "api.spacetraders.io"
local basePath = "/v2"
local scheme = { "https" }
math.randomseed(os.time())

_G.inspect = require("inspect").inspect

_G.apis = {
    spacetraders = {
        default = require('openapiclient.api.default_api').new(authority, basePath, scheme),
        agents = require('openapiclient.api.agents_api').new(authority, basePath, scheme),
        fleet = require('openapiclient.api.fleet_api').new(authority, basePath, scheme),
        systems = require('openapiclient.api.systems_api').new(authority, basePath, scheme),
        contracts = require('openapiclient.api.contracts_api').new(authority, basePath, scheme),
    }
}

function istable(t)
    return type(t) == 'table'
end

function tablelength(T)
    local count = 0
    for _ in pairs(T) do count = count + 1 end
    return count
end

function TableConcat(t1, t2)
    for i = 1, #t2 do
        t1[#t1 + 1] = t2[i]
    end
    return t1
end

function define_event()
    assert(BaseScriptEvent ~= nil)

    local ScriptEvent = {}
    ScriptEvent.__index = ScriptEvent

    function ScriptEvent:_init(evt)
        for k, v in pairs(evt) do
            self[k] = v
        end
    end

    setmetatable(ScriptEvent, {
        __index = BaseScriptEvent, -- This is what makes the inheritance work
        __call = function(cls, ...)
            local self = setmetatable({}, cls)
            self:_init(... or {})
            return self
        end
    })
    assert(ScriptEvent.type_id() == BaseScriptEvent.type_id())
    return ScriptEvent
end

sptr = {
    g = {
        my_agent = {},
        ships = {},
        systems = {},
        system_waypoints = {},
        waypoints = {},
        pending_contracts = {},
        active_contracts = {},
        marketplaces = {},
        shipyards = {},
        system_shipyards = {},
    },
    api = {},
    events = {
        system_selected = define_event(),
        set_camera_position = define_event(),
        camera_moved = define_event(),
        market_selected = define_event(),
        shipyard_selected = define_event(),
    },
    actors = {},
    get_actor = function(name, scene)
        local entity =  scene:findEntityByName(name)
        local sc = entity:getComponent(ScriptComponent)
        if sc == nil then
            log_warn("Failed to get actor ScriptComponent: "..name)
            return nil
        end
        return sc.instance
    end,
}


package.path = package.path .. ";".."../../gui/scripts/?.lua"


function has_trait(waypoint, trait)
    for _,t in ipairs(waypoint.traits) do
        if t.symbol == trait then
            return true
        end
    end
    return false
end

require('data.market')
require('data.shipyard')
